%%{init: {"theme": "base", "themeVariables": { "fontSize": "18px", "fontFamily": "Arial, sans-serif", "primaryColor": "#ffffff", "primaryTextColor": "#000000" }, "flowchart": {"nodeSpacing": 70, "rankSpacing": 100, "curve": "linear"}}}%%
graph TD
    subgraph Kubernetes_Cluster["Kubernetes Cluster"]
        subgraph Linkerd_Control_Plane["Linkerd Control Plane"]
            Linkerd_Viz["Linkerd Viz<br/>Dashboard"]
            Linkerd_Control["Linkerd Control<br/>Manager"]
        end
        
        subgraph LiveKit_Core_Server["LiveKit Core Server"]
            LK_Server["LiveKit Server<br/>Main Service"]
            Linkerd_Proxy_LK["Linkerd Proxy<br/>Sidecar"]
            LK_Server -.-> Linkerd_Proxy_LK
        end
        
        subgraph SIP_Server_Deployment["SIP Server Deployment"]
            SIP_Server["SIP Server<br/>Golang Service"]
            Linkerd_Proxy_SIP["Linkerd Proxy<br/>Sidecar"]
            SIP_Server -.-> Linkerd_Proxy_SIP
        end
        
        subgraph LiveKit_Agent_Deployment["LiveKit Agent"]
            LK_Agent["Custom Agent<br/>Processing Service"]
            Linkerd_Proxy_Agent["Linkerd Proxy<br/>Sidecar"]
            LK_Agent -.-> Linkerd_Proxy_Agent
        end
        
        subgraph LiveKit_Egress_Deployment["LiveKit Egress"]
            LK_Egress["Egress Service<br/>Output Handler"]
            Linkerd_Proxy_Egress["Linkerd Proxy<br/>Sidecar"]
            LK_Egress -.-> Linkerd_Proxy_Egress
        end
        
        subgraph Redis_Deployment["Redis Deployment"]
            Redis["Redis<br/>Cache Store"]
            Redis_Exporter["Redis Exporter<br/>Metrics Collector"]
            Linkerd_Proxy_Redis["Linkerd Proxy<br/>Sidecar"]
            Redis --> Redis_Exporter
            Redis -.-> Linkerd_Proxy_Redis
        end
        
        subgraph Shared_Components["Monitoring Stack"]
            Prometheus["Prometheus<br/>Metrics Database"]
            Grafana["Grafana<br/>Visualization"]
        end
    end
    
    %% External Traffic Flows
    Linkerd_Proxy_LK --> LiveKit_Client_Traffic["Client Traffic<br/>WebRTC/Media"]
    Linkerd_Proxy_SIP --> SIP_Provider_Access["SIP Provider<br/>Telephony"]
    Linkerd_Proxy_Agent --> Agent_Processing_Traffic["Agent Processing<br/>AI/ML Tasks"]
    Linkerd_Proxy_Egress --> Egress_Output["External Outputs<br/>Files/Streams"]
    Linkerd_Proxy_Redis --> Application_Redis_Access["App Redis Access<br/>Data Layer"]
    
    %% Metrics Collection
    LK_Server -->|"Port 6789<br/>Metrics"| Prometheus
    SIP_Server -->|"Custom<br/>Metrics"| Prometheus
    LK_Agent -->|"Custom<br/>Metrics"| Prometheus
    LK_Egress -->|"HTTP<br/>Endpoint"| Prometheus
    Redis_Exporter -->|"Port 9121<br/>Redis Stats"| Prometheus
    Linkerd_Viz -->|"Control Plane<br/>Metrics"| Prometheus
    Linkerd_Control -->|"Service Mesh<br/>Metrics"| Prometheus
    
    %% Linkerd Proxy Metrics
    Linkerd_Proxy_LK -->|"Proxy<br/>Metrics"| Prometheus
    Linkerd_Proxy_SIP -->|"Proxy<br/>Metrics"| Prometheus
    Linkerd_Proxy_Agent -->|"Proxy<br/>Metrics"| Prometheus
    Linkerd_Proxy_Egress -->|"Proxy<br/>Metrics"| Prometheus
    Linkerd_Proxy_Redis -->|"Proxy<br/>Metrics"| Prometheus
    
    %% Visualization
    Prometheus -->|"Time Series<br/>Data Feed"| Grafana
    
    %% Node Styling for Square Shapes
    style Kubernetes_Cluster fill:#f0f8ff,stroke:#1e3a8a,stroke-width:3px
    style Linkerd_Control_Plane fill:#e0f2fe,stroke:#0369a1,stroke-width:2px
    style LiveKit_Core_Server fill:#f0fdf4,stroke:#16a34a,stroke-width:2px
    style SIP_Server_Deployment fill:#fef3c7,stroke:#d97706,stroke-width:2px
    style LiveKit_Agent_Deployment fill:#fce7f3,stroke:#be185d,stroke-width:2px
    style LiveKit_Egress_Deployment fill:#f3e8ff,stroke:#7c3aed,stroke-width:2px
    style Redis_Deployment fill:#fef2f2,stroke:#dc2626,stroke-width:2px
    style Shared_Components fill:#ecfdf5,stroke:#059669,stroke-width:2px
    
    %% Individual node styling for better squares
    style LK_Server fill:#dcfce7,stroke:#16a34a,stroke-width:2px
    style SIP_Server fill:#fef3c7,stroke:#d97706,stroke-width:2px
    style LK_Agent fill:#fce7f3,stroke:#be185d,stroke-width:2px
    style LK_Egress fill:#f3e8ff,stroke:#7c3aed,stroke-width:2px
    style Redis fill:#fef2f2,stroke:#dc2626,stroke-width:2px
    style Prometheus fill:#dbeafe,stroke:#2563eb,stroke-width:2px
    style Grafana fill:#d1fae5,stroke:#059669,stroke-width:2px
